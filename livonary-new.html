<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Livonary - Live Archive</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&family=Noto+Sans+JP:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #05040a;
      --bg-elevated: #11111c;
      --accent: #f8d46a;
      --accent-soft: #f8d46a33;
      --accent-strong: #ffb347;
      --accent-neon: #ff6bd5;
      --text-main: #fdfdf8;
      --text-muted: #a7a7c3;
      --border-subtle: #262636;
      --danger: #ff4b6a;
      --map-base: #151525;
      --map-visited: #f8d46a;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 2000;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal-card {
      width: 100%;
      max-width: 720px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.65);
      max-height: 90vh;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .modal-header {
      padding: 18px 18px 14px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .modal-title {
      font-size: 16px;
      font-weight: 800;
      color: var(--text-main);
      line-height: 1.4;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    .modal-close {
      background: transparent;
      border: 1px solid var(--border-subtle);
      color: var(--text-main);
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 800;
      flex: 0 0 auto;
    }

    .modal-body {
      padding: 16px 18px 18px;
    }

    .modal-kv {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 10px 12px;
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 14px;
    }

    .modal-k {
      color: var(--text-muted);
      font-weight: 700;
    }

    .modal-v {
      color: var(--text-main);
      font-weight: 700;
      word-break: break-word;
      overflow-wrap: anywhere;
      white-space: normal;
    }

    .modal-setlist {
      margin-top: 12px;
      border-top: 1px solid var(--border-subtle);
      padding-top: 12px;
    }

    .modal-setlist-title {
      font-size: 13px;
      font-weight: 800;
      color: var(--accent);
      margin-bottom: 8px;
    }

    .modal-setlist-box {
      background: #0b0b12;
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 12px;
      max-height: min(40vh, 300px);
      overflow-y: auto;
      overflow-x: hidden;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: anywhere;
      color: var(--text-main);
      font-size: 13px;
      line-height: 1.7;
    }

    .modal-artists {
      margin-top: 12px;
      border-top: 1px solid var(--border-subtle);
      padding-top: 12px;
    }

    .modal-artists-title {
      font-size: 13px;
      font-weight: 800;
      color: var(--accent);
      margin-bottom: 8px;
    }

    .modal-artists-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      max-height: min(40vh, 320px);
      overflow-y: auto;
      overflow-x: hidden;
      padding: 4px;
    }

    .artist-chip {
      border: 1px solid var(--border-subtle);
      background: var(--bg);
      color: var(--text-main);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      line-height: 1.2;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 16px;
      gap: 10px;
    }

    .modal-primary {
      background: var(--accent);
      border: 1px solid var(--accent);
      color: var(--bg);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 900;
      cursor: pointer;
    }

    .modal-danger {
      background: rgba(255, 75, 106, 0.12);
      border: 1px solid rgba(255, 75, 106, 0.45);
      color: var(--danger);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 900;
      cursor: pointer;
    }

    @media (max-width: 480px) {
      .modal-kv {
        grid-template-columns: 90px 1fr;
      }

      .modal-artists-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Noto Sans JP", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at 10% -10%, #473259 0, transparent 45%),
        radial-gradient(circle at 90% 110%, #5a3822 0, transparent 45%),
        radial-gradient(circle at 50% 50%, #161521 0, #05040a 65%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      padding: 32px 20px 40px;
    }

    .app-shell {
      width: 100%;
      max-width: 1600px;
      background:
        linear-gradient(145deg, #05050bfa, #10101efa),
        repeating-linear-gradient(135deg, #14131f 0, #14131f 4px, #101018 4px, #101018 8px);
      border-radius: 28px;
      border: 1px solid #f8d46a44;
      box-shadow:
        0 0 0 1px #000000dd,
        0 26px 70px rgba(0, 0, 0, 0.95),
        0 0 120px #f8d46a18;
      padding: 32px 20px 40px;
      backdrop-filter: blur(20px);
      position: relative;
      overflow: hidden;
    }

    /* æ–°ã—ã„ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ§‹é€  */
    .main-navigation {
      position: sticky;
      top: 0;
      background: linear-gradient(145deg, #05050bfa, #10101efa);
      border-radius: 20px;
      padding: 16px 24px;
      margin-bottom: 32px;
      border: 1px solid #f8d46a33;
      backdrop-filter: blur(20px);
      z-index: 100;
    }

    .nav-items {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .nav-item {
      padding: 12px 24px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      color: var(--text-main);
      text-decoration: none;
      font-weight: 500;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .nav-item:hover {
      background: var(--accent-soft);
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .nav-item.active {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }

    /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ç¸¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .content-section {
      margin-bottom: 48px;
      background: linear-gradient(145deg, #05050bfa, #10101efa);
      border-radius: 20px;
      padding: 32px;
      border: 1px solid #f8d46a22;
    }

    .section-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 24px;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .section-icon {
      font-size: 28px;
    }

    /* å·¨å¤§åœ°å›³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .map-section {
      width: 100%;
      min-height: 600px;
      position: relative;
    }

    .map-container {
      width: 100%;
      height: 600px;
      background: #0b0b12;
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      overflow: hidden;
      position: relative;
    }

    .map-svg {
      width: 100%;
      height: 100%;
    }

    /* çµ±è¨ˆè³‡æ–™é¢¨ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰ */
    .jp-map-pref {
      fill: var(--map-base);
      stroke: #3a3a52;
      stroke-width: 1.35;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .jp-map-pref:hover {
      filter: brightness(1.15);
      stroke-width: 1.1;
    }

    /* ã‚´ãƒ¼ãƒ«ãƒ‰è‰²ï¼ˆãƒ©ã‚¤ãƒ–è¨˜éŒ²ãŒã‚ã‚‹éƒ½é“åºœçœŒï¼‰ */
    .jp-map-pref.visited {
      fill: var(--map-visited);
      filter: drop-shadow(0 0 8px rgba(248, 212, 106, 0.45));
      stroke: #ffe29a;
      stroke-width: 1.45;
    }

    .jp-map-pref.visited:hover {
      fill: #ffdf7c;
      filter: drop-shadow(0 0 10px rgba(248, 212, 106, 0.5));
    }

    /* åœ°å›³ä¸Šã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
    .map-tooltip {
      position: absolute;
      background: var(--bg);
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 14px;
      color: var(--text-main);
      pointer-events: none;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.2s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .map-tooltip.visible {
      opacity: 1;
    }

    .tooltip-prefecture {
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .tooltip-count {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .form-section {
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
    }

    .form-container {
      background: var(--bg-elevated);
      border-radius: 16px;
      padding: 32px;
      border: 1px solid var(--border-subtle);
    }

    .form-grid-new {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
    }

    .form-field {
      display: flex;
      flex-direction: column;
    }

    .form-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .form-input {
      padding: 16px;
      font-size: 16px;
      background: var(--bg);
      border: 2px solid var(--border-subtle);
      border-radius: 12px;
      color: var(--text-main);
      transition: all 0.3s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    .form-submit {
      width: 100%;
      padding: 18px;
      font-size: 18px;
      font-weight: 700;
      background: var(--accent);
      color: var(--bg);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 16px;
    }

    .form-submit:hover {
      background: var(--accent-strong);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(248, 212, 106, 0.3);
    }

    /* ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .radio-group-new {
      display: flex;
      gap: 20px;
      margin-top: 8px;
    }

    .radio-option-new {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 12px 20px;
      background: var(--bg);
      border: 2px solid var(--border-subtle);
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .radio-option-new:hover {
      border-color: var(--accent);
    }

    .radio-option-new input[type="radio"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    .radio-option-new.selected {
      background: var(--accent-soft);
      border-color: var(--accent);
    }

    .helper-text {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    /* åœ°å›³ã¨çµ±è¨ˆã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .map-content {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
      height: 600px;
      width: 100%;
    }

    .map-area {
      position: relative;
      background: var(--bg-elevated);
      border-radius: 16px;
      padding: 0;
      border: 1px solid var(--border-subtle);
      overflow: hidden;
      min-width: 0;
    }

    /* è»½é‡SVGåœ°å›³ */
    .map-svg {
      width: 100%;
      height: 100%;
      border-radius: 12px;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    #jpMapContainer {
      width: 100%;
      height: 100%;
    }

    #jpMapContainer svg {
      width: 100%;
      height: auto;
      max-width: 100%;
      max-height: 100%;
      display: block;
    }

    /* ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚° */
    .artist-ranking {
      background: var(--bg-elevated);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid var(--border-subtle);
      overflow-y: auto;
      min-width: 0;
    }

    .ranking-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 16px;
    }

    .year-filter {
      margin-bottom: 16px;
    }

    .year-select {
      width: 100%;
      padding: 8px 12px;
      background: var(--bg);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      color: var(--text-main);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .year-select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .summary-panel {
      background: var(--bg);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .summary-item {
      display: flex;
      align-items: center;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 8px;
    }

    .summary-item:last-child {
      margin-bottom: 0;
    }

    .summary-icon {
      margin-right: 8px;
      font-size: 16px;
    }

    .summary-value {
      color: var(--accent);
      font-weight: 700;
    }

    .ranking-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .ranking-tab {
      padding: 6px 12px;
      background: var(--bg);
      border: 1px solid var(--border-subtle);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      color: var(--text-main);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .ranking-tab:hover {
      border-color: var(--accent);
    }

    .ranking-tab.active {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }

    .ranking-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .ranking-list.expanded {
      max-height: none;
    }

    .ranking-expand {
      margin-top: 12px;
      padding: 8px 12px;
      background: var(--bg);
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      color: var(--text-main);
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .ranking-expand:hover {
      border-color: var(--accent);
      background: var(--accent-soft);
    }

    .ranking-item {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .ranking-item:last-child {
      border-bottom: none;
    }

    .setlist-toggle {
      width: 100%;
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      background: var(--bg);
      color: var(--text-main);
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.02em;
      transition: all 0.2s ease;
      text-align: left;
    }

    .setlist-toggle:hover {
      border-color: var(--accent);
      background: var(--accent-soft);
    }

    .setlist-content {
      margin-top: 10px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: #0b0b12;
      color: var(--text-main);
      white-space: pre-wrap;
      word-wrap: break-word;
      word-break: break-word;
      overflow-wrap: anywhere;
      line-height: 1.6;
      font-size: 13px;
      display: none;
    }

    .setlist-content.open {
      display: block;
      max-height: min(40vh, 300px);
      overflow-y: auto;
      overflow-x: hidden;
    }

    .ranking-number {
      width: 24px;
      height: 24px;
      background: var(--accent);
      color: var(--bg);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      margin-right: 12px;
    }

    .ranking-number.gold {
      background: linear-gradient(135deg, #ffd700, #ffed4e);
      color: #000;
    }

    .ranking-number.silver {
      background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
      color: #000;
    }

    .ranking-number.bronze {
      background: linear-gradient(135deg, #cd7f32, #e8a75d);
      color: #fff;
    }

    .ranking-artist {
      flex: 1;
      font-size: 14px;
      color: var(--text-main);
    }

    .ranking-count {
      font-size: 14px;
      font-weight: 700;
      color: var(--accent);
    }

    .ranking-detail {
      font-size: 12px;
      color: var(--text-muted);
      margin-left: 8px;
    }

    /* ãƒ‡ã‚¤ãƒˆãƒ”ãƒƒã‚«ãƒ¼ */
    .date-input-container {
      display: flex;
      gap: 8px;
    }

    .date-input {
      flex: 1;
    }

    .date-picker-btn {
      background: var(--accent);
      border: none;
      border-radius: 8px;
      padding: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .date-picker-btn:hover {
      background: var(--accent-strong);
      transform: translateY(-1px);
    }

    /* ãƒã‚±ãƒƒãƒˆä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .collection-section {
      width: 100%;
    }

    /* é«˜ã•èª¿æ•´ */
    .content-section {
      height: calc(100vh - 200px);
      overflow-y: auto;
      padding: 24px;
    }

    .map-section {
      height: 100%;
    }

    .map-container {
      height: 100%;
    }

    .form-section {
      height: 100%;
    }

    .form-container {
      height: 100%;
      overflow-y: auto;
    }

    .collection-section {
      height: 100%;
    }

    .tickets-grid {
      height: 100%;
      overflow-y: auto;
    }

    .ticket-card {
      background: var(--bg-elevated);
      border-radius: 16px;
    }

    .tickets-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 24px;
      padding: 8px;
    }

    .ticket-card {
      background: var(--bg-elevated);
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      overflow: hidden;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }

    .ticket-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.3);
      border-color: var(--accent);
    }

    .ticket-header {
      background: linear-gradient(135deg, var(--accent-soft), transparent);
      padding: 20px;
      border-bottom: 1px solid var(--border-subtle);
      position: relative;
      padding-right: 132px;
    }

    .ticket-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 8px;
      line-height: 1.35;
      word-break: break-word;
      overflow-wrap: anywhere;
      padding-right: 48px;
      max-width: calc(100% - 48px);
      white-space: normal;
    }

    .ticket-artist {
      font-size: 16px;
      color: var(--accent);
      font-weight: 600;
    }

    .ticket-artists {
      margin-top: 10px;
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.6;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    .ticket-body {
      padding: 20px;
    }

    .ticket-info {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .ticket-info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
    }

    .ticket-info-label {
      color: var(--text-muted);
      font-weight: 500;
    }

    .ticket-info-value {
      color: var(--text-main);
      font-weight: 600;
    }

    .ticket-type {
      position: absolute;
      top: 15px;
      right: 15px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .ticket-type.solo {
      background: #4ade80;
      color: var(--bg);
    }

    .ticket-type.festival {
      background: var(--accent);
      color: var(--bg);
    }

    /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
    @media (max-width: 768px) {
      body {
        padding: 16px 8px 24px;
      }

      .app-shell {
        padding: 20px 12px 24px;
        border-radius: 20px;
      }

      .main-navigation {
        padding: 12px 16px;
        margin-bottom: 20px;
      }

      .nav-items {
        gap: 6px;
      }

      .nav-item {
        padding: 10px 16px;
        font-size: 14px;
      }

      .content-section {
        padding: 20px;
        margin-bottom: 24px;
        height: auto !important;
        overflow-y: visible !important;
      }

      .section-title {
        font-size: 20px;
      }

      #analytics.content-section {
        padding: 16px 12px;
        overflow-x: hidden;
        height: auto;
        overflow-y: visible;
      }

      .map-section {
        height: auto;
      }

      .map-container {
        display: flex !important;
        flex-direction: column !important;
        height: auto !important;
        overflow: visible !important;
      }

      .map-container {
        width: 100%;
        max-width: 100vw;
      }

      .map-content {
        display: flex !important;
        flex-direction: column !important;
        gap: 16px;
        width: 100%;
        max-width: 100vw;
        height: auto;
        align-items: stretch;
      }

      .map-area {
        width: 100%;
        max-width: 100vw;
        height: auto !important;
        max-height: none !important;
        order: 1;
        margin-bottom: 8px;
        overflow: visible !important;
      }

      .map-svg {
        width: 100%;
        max-width: 100vw;
      }

      #jpMapContainer {
        width: 100%;
        max-width: 100vw;
      }

      #jpMapContainer svg {
        width: 100% !important;
        height: auto !important;
        max-width: 100vw !important;
        max-height: 60vh !important;
      }

      .artist-ranking {
        display: block !important;
        width: 100% !important;
        max-width: 100vw !important;
        min-height: 200px !important;
        max-height: none;
        overflow-y: visible;
        opacity: 1 !important;
        visibility: visible !important;
        order: 2;
        margin-top: 20px !important;
      }

      .ranking-list {
        max-height: none !important;
        overflow-y: visible !important;
        display: block !important;
        width: 100% !important;
        min-height: 200px !important;
        opacity: 1 !important;
        visibility: visible !important;
      }

      .map-container {
        height: auto;
      }

      .form-container {
        padding: 20px;
      }

      .form-input {
        padding: 14px;
        font-size: 16px;
      }

      .tickets-grid {
        grid-template-columns: 1fr;
        gap: 16px;
        padding: 4px;
      }

      .ticket-header {
        padding: 16px;
      }

      .ticket-body {
        padding: 16px;
      }

    }

    @media (max-width: 480px) {
      .nav-items {
        flex-direction: column;
        gap: 8px;
      }

      .nav-item {
        width: 100%;
        text-align: center;
        padding: 12px;
      }

      .map-container {
        height: 300px;
      }

      .map-area {
        height: 260px;
      }

      .form-container {
        padding: 16px;
      }

      .radio-group-new {
        flex-direction: column;
        gap: 12px;
      }

    }

    /* Toast */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%) translateY(120%);
      padding: 8px 14px;
      background: #050509f2;
      color: var(--accent);
      border-radius: 999px;
      border: 1px solid #f8d46a66;
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-family: "Roboto Condensed", system-ui, sans-serif;
      box-shadow:
        0 0 15px #f8d46a44,
        0 10px 25px rgba(0, 0, 0, 0.9);
      opacity: 0;
      pointer-events: none;
      transition: transform 0.25s ease, opacity 0.25s ease;
      z-index: 50;
    }

    .toast.visible {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .tickets-empty {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
      font-size: 16px;
    }

    .prefecture-tooltip {
      position: absolute;
      background: var(--bg);
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--text-main);
      pointer-events: none;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.2s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      max-width: 200px;
    }

    .prefecture-tooltip.visible {
      opacity: 1;
    }

    .prefecture-tooltip-title {
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .prefecture-tooltip-counts {
      font-size: 11px;
      color: var(--text-muted);
    }

    .ticket-setlist {
      font-size: 12px;
      color: var(--text-muted);
      padding: 8px 0;
      border-top: 1px solid var(--border-subtle);
    }

    .ticket-setlist-toggle {
      font-size: 12px;
      color: var(--text-main);
      cursor: pointer;
      margin-bottom: 8px;
    }

    .ticket-setlist-toggle:hover {
      text-decoration: underline;
    }

  </style>
</head>
<body>
  <div class="app-shell">
    <div class="app-shell-inner">
      <!-- æ–°ã—ã„ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
      <nav class="main-navigation">
        <div class="nav-items">
          <a href="#analytics" class="nav-item active" data-section="analytics">
            <span class="section-icon">ğŸ—ºï¸</span>
            å…¨å›½ãƒ©ã‚¤ãƒ–ãƒãƒƒãƒ—
          </a>
          <a href="#add-live" class="nav-item" data-section="add-live">
            <span class="section-icon">â•</span>
            ãƒ©ã‚¤ãƒ–è¨˜éŒ²
          </a>
          <a href="#collection" class="nav-item" data-section="collection">
            <span class="section-icon">ğŸ«</span>
            ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
          </a>
        </div>
      </nav>

      <!-- åœ°å›³ãƒ»çµ±è¨ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <section id="analytics" class="content-section">
        <div class="section-title">
          <span class="section-icon">ï¿½</span>
          å‚æˆ¦ã®è¶³è·¡
        </div>
        <div class="map-section">
          <div class="map-container">
            <div class="map-title">ğŸ“ å‚æˆ¦ã®è¶³è·¡</div>
            <div class="map-content">
              <div class="map-area">
                <div id="jpMapContainer" class="map-svg" aria-label="æ—¥æœ¬åœ°å›³"></div>
                <div id="mapTooltip" class="map-tooltip" role="tooltip"></div>
              </div>
              
              <!-- ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆçµ±è¨ˆãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
              <div class="artist-ranking">
                <div class="ranking-title">ğŸ† ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆå‚æˆ¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
                
                <!-- å¹´åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ -->
                <div class="year-filter">
                  <select id="yearSelect" class="year-select">
                    <option value="all">å…¨æœŸé–“</option>
                  </select>
                </div>

                <!-- ç·åˆã‚µãƒãƒªãƒ¼ -->
                <div class="summary-panel" id="summaryPanel">
                  <div class="summary-item">
                    <span class="summary-icon">ğŸ—“ï¸</span>
                    <span>ç·å‚æˆ¦æ•°ï¼š<span class="summary-value" id="totalCount">0</span>å›</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-icon">ğŸ¤</span>
                    <span>å˜ç‹¬ãƒ©ã‚¤ãƒ–ï¼š<span class="summary-value" id="soloCount">0</span>å›</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-icon">ğŸª</span>
                    <span>ãƒ•ã‚§ã‚¹ï¼š<span class="summary-value" id="festivalCount">0</span>å›</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-icon">ğŸ—¾</span>
                    <span>é€šç®—åˆ¶è¦‡éƒ½é“åºœçœŒï¼š<span class="summary-value" id="prefCount">0</span> / 47</span>
                  </div>
                </div>

                <div class="ranking-tabs">
                  <button class="ranking-tab active" data-mode="total">åˆè¨ˆ</button>
                  <button class="ranking-tab" data-mode="solo">å˜ç‹¬ã®ã¿</button>
                  <button class="ranking-tab" data-mode="festival">ãƒ•ã‚§ã‚¹ã®ã¿</button>
                </div>
                <div class="ranking-list" id="artistRankingList">
                  <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
                <button class="ranking-expand" id="rankingExpand" style="display: none;">ã™ã¹ã¦è¦‹ã‚‹</button>
              </div>
            </div>
          </div>
        </div>

      </section>

      <!-- ãƒ©ã‚¤ãƒ–è¨˜éŒ²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <section id="add-live" class="content-section" style="display: none;">
        <div class="section-title">
          <span class="section-icon">â•</span>
          æ–°ã—ã„ãƒ©ã‚¤ãƒ–è¨˜éŒ²
        </div>
        <div class="form-section">
          <div class="form-container">
            <form id="liveFormNew" autocomplete="off">
              <div class="form-grid-new">
                <div class="form-field">
                  <label class="form-label" for="title">ãƒ©ã‚¤ãƒ–ã‚¿ã‚¤ãƒˆãƒ«</label>
                  <input type="text" id="title" name="title" class="form-input" placeholder="ä¾‹ï¼šONE-MAN TOUR 2025 FINAL" required />
                </div>

                <div class="form-field">
                  <label class="form-label">ãƒ©ã‚¤ãƒ–ç¨®åˆ¥</label>
                  <div class="radio-group-new">
                    <label class="radio-option-new">
                      <input type="radio" name="liveType" value="solo" checked />
                      <span>å˜ç‹¬ãƒ©ã‚¤ãƒ–</span>
                    </label>
                    <label class="radio-option-new">
                      <input type="radio" name="liveType" value="festival" />
                      <span>ãƒ•ã‚§ã‚¹</span>
                    </label>
                  </div>
                </div>

                <div class="form-field">
                  <label class="form-label" for="artist">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆå</label>
                  <div id="artistInputContainer">
                    <input type="text" id="artist" name="artist" class="form-input" placeholder="ä¾‹ï¼šBand Name" required />
                    <div class="helper-text">ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’å…¥åŠ›å¯èƒ½ï¼ˆä¾‹ï¼šArtist A, Artist Bï¼‰</div>
                    <div id="festivalArtistsContainer" style="display: none; margin-top: 12px;">
                      <div class="form-label">ãƒ•ã‚§ã‚¹å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</div>
                      <textarea id="festivalArtists" name="festivalArtists" class="form-input" rows="3" placeholder="ä¾‹ï¼šArtist A, Artist B, Artist C"></textarea>
                      <div class="helper-text">ã‚«ãƒ³ãƒã§åŒºåˆ‡ã£ã¦è¤‡æ•°ã®ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
                    </div>
                  </div>
                </div>

                <div class="form-field">
                  <label class="form-label" for="date">å…¬æ¼”æ—¥</label>
                  <input type="date" id="date" name="date" class="form-input" required />
                </div>

                <div class="form-field">
                  <label class="form-label" for="endDate">çµ‚äº†æ—¥ï¼ˆä»»æ„ï¼‰</label>
                  <input type="date" id="endDate" name="endDate" class="form-input" />
                </div>

                <div class="form-field">
                  <label class="form-label" for="venue">ä¼šå ´å</label>
                  <input type="text" id="venue" name="venue" class="form-input" placeholder="ä¾‹ï¼šZepp â—‹â—‹ / LIQUIDROOM ãªã©" required />
                </div>

                <div class="form-field">
                  <label class="form-label" for="seat">åº§å¸­</label>
                  <input type="text" id="seat" name="seat" class="form-input" placeholder="ä¾‹ï¼š1éš Aåˆ— 12ç•ª / æ•´ç•ª 123ç•ª" />
                </div>

                <div class="form-field">
                  <label class="form-label" for="setlist">ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆï¼ˆä»»æ„ï¼‰</label>
                  <textarea id="setlist" name="setlist" class="form-input" rows="6" placeholder="æ›²é †ã‚„ãƒ¡ãƒ¢ã‚’è‡ªç”±ã«å…¥åŠ›ã§ãã¾ã™"></textarea>
                </div>

                <div class="form-field">
                  <label class="form-label" for="prefecture">éƒ½é“åºœçœŒ</label>
                  <select id="prefecture" name="prefecture" class="form-input" required>
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    <option value="åŒ—æµ·é“">åŒ—æµ·é“</option>
                    <option value="é’æ£®çœŒ">é’æ£®çœŒ</option>
                    <option value="å²©æ‰‹çœŒ">å²©æ‰‹çœŒ</option>
                    <option value="å®®åŸçœŒ">å®®åŸçœŒ</option>
                    <option value="ç§‹ç”°çœŒ">ç§‹ç”°çœŒ</option>
                    <option value="å±±å½¢çœŒ">å±±å½¢çœŒ</option>
                    <option value="ç¦å³¶çœŒ">ç¦å³¶çœŒ</option>
                    <option value="èŒ¨åŸçœŒ">èŒ¨åŸçœŒ</option>
                    <option value="æ ƒæœ¨çœŒ">æ ƒæœ¨çœŒ</option>
                    <option value="ç¾¤é¦¬çœŒ">ç¾¤é¦¬çœŒ</option>
                    <option value="åŸ¼ç‰çœŒ">åŸ¼ç‰çœŒ</option>
                    <option value="åƒè‘‰çœŒ">åƒè‘‰çœŒ</option>
                    <option value="æ±äº¬éƒ½">æ±äº¬éƒ½</option>
                    <option value="ç¥å¥ˆå·çœŒ">ç¥å¥ˆå·çœŒ</option>
                    <option value="æ–°æ½ŸçœŒ">æ–°æ½ŸçœŒ</option>
                    <option value="å¯Œå±±çœŒ">å¯Œå±±çœŒ</option>
                    <option value="çŸ³å·çœŒ">çŸ³å·çœŒ</option>
                    <option value="ç¦äº•çœŒ">ç¦äº•çœŒ</option>
                    <option value="å±±æ¢¨çœŒ">å±±æ¢¨çœŒ</option>
                    <option value="é•·é‡çœŒ">é•·é‡çœŒ</option>
                    <option value="å²é˜œçœŒ">å²é˜œçœŒ</option>
                    <option value="é™å²¡çœŒ">é™å²¡çœŒ</option>
                    <option value="æ„›çŸ¥çœŒ">æ„›çŸ¥çœŒ</option>
                    <option value="ä¸‰é‡çœŒ">ä¸‰é‡çœŒ</option>
                    <option value="æ»‹è³€çœŒ">æ»‹è³€çœŒ</option>
                    <option value="äº¬éƒ½åºœ">äº¬éƒ½åºœ</option>
                    <option value="å¤§é˜ªåºœ">å¤§é˜ªåºœ</option>
                    <option value="å…µåº«çœŒ">å…µåº«çœŒ</option>
                    <option value="å¥ˆè‰¯çœŒ">å¥ˆè‰¯çœŒ</option>
                    <option value="å’Œæ­Œå±±çœŒ">å’Œæ­Œå±±çœŒ</option>
                    <option value="é³¥å–çœŒ">é³¥å–çœŒ</option>
                    <option value="å³¶æ ¹çœŒ">å³¶æ ¹çœŒ</option>
                    <option value="å²¡å±±çœŒ">å²¡å±±çœŒ</option>
                    <option value="åºƒå³¶çœŒ">åºƒå³¶çœŒ</option>
                    <option value="å±±å£çœŒ">å±±å£çœŒ</option>
                    <option value="å¾³å³¶çœŒ">å¾³å³¶çœŒ</option>
                    <option value="é¦™å·çœŒ">é¦™å·çœŒ</option>
                    <option value="æ„›åª›çœŒ">æ„›åª›çœŒ</option>
                    <option value="é«˜çŸ¥çœŒ">é«˜çŸ¥çœŒ</option>
                    <option value="ç¦å²¡çœŒ">ç¦å²¡çœŒ</option>
                    <option value="ä½è³€çœŒ">ä½è³€çœŒ</option>
                    <option value="é•·å´çœŒ">é•·å´çœŒ</option>
                    <option value="ç†Šæœ¬çœŒ">ç†Šæœ¬çœŒ</option>
                    <option value="å¤§åˆ†çœŒ">å¤§åˆ†çœŒ</option>
                    <option value="å®®å´çœŒ">å®®å´çœŒ</option>
                    <option value="é¹¿å…å³¶çœŒ">é¹¿å…å³¶çœŒ</option>
                    <option value="æ²–ç¸„çœŒ">æ²–ç¸„çœŒ</option>
                  </select>
                </div>
              </div>
              <button type="submit" class="form-submit">ãƒ©ã‚¤ãƒ–ã‚’è¨˜éŒ²</button>
            </form>
          </div>
        </div>
      </section>

      <!-- ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <section id="collection" class="content-section" style="display: none;">
        <div class="section-title">
          <span class="section-icon">ğŸ«</span>
          ãƒã‚±ãƒƒãƒˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
        </div>
        <div class="collection-section">
          <div class="tickets-grid" id="ticketsGrid">
            <!-- ãƒã‚±ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å…¥ã‚‹ -->
          </div>
          <div id="ticketsEmpty" class="tickets-empty" style="display: none;">
            ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br />
            ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã€åˆã‚ã¦ã®1æšã‚’ä¿å­˜ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
          </div>
        </div>
      </section>
    </div>
  </div>

  <div id="toast" class="toast">ä¿å­˜ã—ã¾ã—ãŸ</div>

  <div id="liveDetailModal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card" role="document">
      <div class="modal-header">
        <div class="modal-title" id="liveDetailTitle"></div>
        <button type="button" class="modal-close" id="liveDetailClose">é–‰ã˜ã‚‹</button>
      </div>
      <div class="modal-body" id="liveDetailBody"></div>
    </div>
  </div>

  <script>
    // Livonary Main Application
    (function() {
      const STORAGE_KEY = "livonary-entries-v2";
      let allEntries = [];
      let currentSection = 'analytics';
      let editingEntryId = null;
      let rankingMode = 'total'; // 'total', 'solo', 'festival'
      let rankingExpanded = false;
      let selectedYear = 'all'; // 'all' or specific year

      const PREF_BY_CODE = [
        '',
        'åŒ—æµ·é“',
        'é’æ£®çœŒ',
        'å²©æ‰‹çœŒ',
        'å®®åŸçœŒ',
        'ç§‹ç”°çœŒ',
        'å±±å½¢çœŒ',
        'ç¦å³¶çœŒ',
        'èŒ¨åŸçœŒ',
        'æ ƒæœ¨çœŒ',
        'ç¾¤é¦¬çœŒ',
        'åŸ¼ç‰çœŒ',
        'åƒè‘‰çœŒ',
        'æ±äº¬éƒ½',
        'ç¥å¥ˆå·çœŒ',
        'æ–°æ½ŸçœŒ',
        'å¯Œå±±çœŒ',
        'çŸ³å·çœŒ',
        'ç¦äº•çœŒ',
        'å±±æ¢¨çœŒ',
        'é•·é‡çœŒ',
        'å²é˜œçœŒ',
        'é™å²¡çœŒ',
        'æ„›çŸ¥çœŒ',
        'ä¸‰é‡çœŒ',
        'æ»‹è³€çœŒ',
        'äº¬éƒ½åºœ',
        'å¤§é˜ªåºœ',
        'å…µåº«çœŒ',
        'å¥ˆè‰¯çœŒ',
        'å’Œæ­Œå±±çœŒ',
        'é³¥å–çœŒ',
        'å³¶æ ¹çœŒ',
        'å²¡å±±çœŒ',
        'åºƒå³¶çœŒ',
        'å±±å£çœŒ',
        'å¾³å³¶çœŒ',
        'é¦™å·çœŒ',
        'æ„›åª›çœŒ',
        'é«˜çŸ¥çœŒ',
        'ç¦å²¡çœŒ',
        'ä½è³€çœŒ',
        'é•·å´çœŒ',
        'ç†Šæœ¬çœŒ',
        'å¤§åˆ†çœŒ',
        'å®®å´çœŒ',
        'é¹¿å…å³¶çœŒ',
        'æ²–ç¸„çœŒ'
      ];

      window.addEventListener('error', (event) => {
        try {
          console.error('Unhandled error:', event.error || event.message);
          showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆConsoleã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰');
        } catch {
          // ignore
        }
      });

      window.addEventListener('unhandledrejection', (event) => {
        try {
          console.error('Unhandled promise rejection:', event.reason);
          showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆConsoleã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰');
        } catch {
          // ignore
        }
      });

      // åˆæœŸåŒ–
      function init() {
        loadEntries();
        setupNavigation();
        setupForm();
        setupCollectionInteractions();
        setupRankingTabs();
        setupYearFilter();
        initJapanMapSvg();
        updateDisplay();
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§åœ°å›³ãƒ»çµ±è¨ˆã‚’è¡¨ç¤º
        switchSection('analytics');
      }

      // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      function loadEntries() {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (!stored) {
            allEntries = [];
            return;
          }
          const parsed = JSON.parse(stored);
          allEntries = Array.isArray(parsed) ? parsed : [];

          // æ—§ãƒ‡ãƒ¼ã‚¿ã®è£œæ­£ï¼ˆå£Šã‚ŒãŸæ—¥ä»˜ã‚’æ­£è¦åŒ–ã—ã¦ä¿å­˜ã—ç›´ã™ï¼‰
          let changed = false;
          allEntries = allEntries.map((e) => {
            if (!e || typeof e !== 'object') return e;
            if (typeof e.date === 'string') {
              const normalized = normalizeDateString(e.date);
              if (normalized !== e.date) {
                changed = true;
                return { ...e, date: normalized };
              }
            }
            if (typeof e.endDate === 'string') {
              const normalizedEnd = normalizeDateString(e.endDate);
              if (normalizedEnd !== e.endDate) {
                changed = true;
                return { ...e, endDate: normalizedEnd };
              }
            }
            return e;
          });

          // æ—§ãƒ•ã‚§ã‚¹ãƒ‡ãƒ¼ã‚¿ã®çµ±åˆï¼ˆå‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã”ã¨ã«è¤‡æ•°ãƒ¬ã‚³ãƒ¼ãƒ‰ã«ãªã£ã¦ã„ã‚‹ã‚‚ã®ã‚’1ã¤ã«ã¾ã¨ã‚ã‚‹ï¼‰
          {
            const groups = new Map();
            const passthrough = [];
            allEntries.forEach((e) => {
              if (!e || typeof e !== 'object' || e.liveType !== 'festival') {
                passthrough.push(e);
                return;
              }

              const dateKey = typeof e.date === 'string' ? e.date : '';
              const titleKey = typeof e.title === 'string' ? e.title : '';
              const venueKey = typeof e.venue === 'string' ? e.venue : '';
              const prefKey = typeof e.prefecture === 'string' ? e.prefecture : '';
              const key = `${dateKey}__${titleKey}__${venueKey}__${prefKey}`;

              const existing = groups.get(key);
              if (!existing) {
                const artistName = typeof e.artist === 'string' ? e.artist : '';
                groups.set(key, {
                  ...e,
                  artists: Array.isArray(e.artists) ? e.artists.slice() : (artistName ? [artistName] : []),
                });
              } else {
                const artistName = typeof e.artist === 'string' ? e.artist : '';
                const add = Array.isArray(e.artists) ? e.artists : (artistName ? [artistName] : []);
                const merged = [...(existing.artists || []), ...add].map(s => String(s || '').trim()).filter(Boolean);
                existing.artists = Array.from(new Set(merged));
                changed = true;
              }
            });

            if (groups.size > 0) {
              allEntries = [...passthrough, ...Array.from(groups.values())];
            }
          }

          if (changed) {
            saveEntries();
          }
        } catch (e) {
          console.error('Failed to load entries', e);
          allEntries = [];
        }
      }

      // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
      function saveEntries() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(allEntries));
        } catch (e) {
          console.error('Failed to save entries', e);
        }
      }

      // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
      function setupNavigation() {
        const navItems = document.querySelectorAll('.nav-item');
        if (!navItems.length) {
          console.warn('Navigation items not found');
        }
        navItems.forEach(item => {
          item.addEventListener('click', (e) => {
            e.preventDefault();
            const section = item.getAttribute('data-section');
            if (!section) return;
            switchSection(section);
          });
        });
      }

      // ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆ
      function switchSection(section) {
        if (!section) return;
        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
        document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.remove('active');
        });
        const activeNav = document.querySelector(`[data-section="${section}"]`);
        if (activeNav) {
          activeNav.classList.add('active');
        }

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.content-section').forEach(sec => {
          sec.style.display = 'none';
        });
        
        const targetSection = document.getElementById(section);
        if (targetSection) {
          targetSection.style.display = 'block';
        } else {
          console.warn('Section not found:', section);
        }

        currentSection = section;
        updateDisplay();
      }

      // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚¿ãƒ–è¨­å®š
      function setupRankingTabs() {
        const tabs = document.querySelectorAll('.ranking-tab');
        const expandBtn = document.getElementById('rankingExpand');
        
        tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            const mode = tab.getAttribute('data-mode');
            if (!mode) return;
            
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            rankingMode = mode;
            rankingExpanded = false;
            updateArtistRanking();
          });
        });

        if (expandBtn) {
          expandBtn.addEventListener('click', () => {
            rankingExpanded = !rankingExpanded;
            updateArtistRanking();
          });
        }
      }

      // å¹´ãƒ•ã‚£ãƒ«ã‚¿è¨­å®š
      function setupYearFilter() {
        const yearSelect = document.getElementById('yearSelect');
        if (!yearSelect) return;

        // å¹´ã®ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
        const years = new Set();
        allEntries.forEach(entry => {
          if (entry && entry.date) {
            const year = new Date(entry.date).getFullYear();
            years.add(year);
          }
        });

        const sortedYears = Array.from(years).sort((a, b) => b - a);
        yearSelect.innerHTML = '<option value="all">å…¨æœŸé–“</option>';
        sortedYears.forEach(year => {
          yearSelect.innerHTML += `<option value="${year}">${year}å¹´</option>`;
        });

        yearSelect.addEventListener('change', (e) => {
          selectedYear = e.target.value;
          updateMap();
          updateArtistRanking();
          updateSummary();
        });
      }

      // ã‚µãƒãƒªãƒ¼æ›´æ–°
      function updateSummary() {
        const totalCountEl = document.getElementById('totalCount');
        const soloCountEl = document.getElementById('soloCount');
        const festivalCountEl = document.getElementById('festivalCount');
        const prefCountEl = document.getElementById('prefCount');

        if (!totalCountEl || !soloCountEl || !festivalCountEl || !prefCountEl) return;

        let totalCount = 0;
        let soloCount = 0;
        let festivalCount = 0;
        const visitedPrefs = new Set();

        allEntries.forEach(entry => {
          if (!entry) return;
          
          // å¹´ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
          if (selectedYear !== 'all') {
            const entryYear = new Date(entry.date).getFullYear().toString();
            if (entryYear !== selectedYear) return;
          }

          totalCount++;
          if (entry.liveType === 'festival') {
            festivalCount++;
          } else {
            soloCount++;
          }

          if (entry.prefecture) {
            visitedPrefs.add(entry.prefecture);
          }
        });

        totalCountEl.textContent = totalCount;
        soloCountEl.textContent = soloCount;
        festivalCountEl.textContent = festivalCount;
        prefCountEl.textContent = visitedPrefs.size;
      }

      // åœ°å›³æ›´æ–°
      function updateMap() {
        const prefectureCounts = buildPrefectureStats();

        // åœ°å›³ã«è‰²ã‚’é©ç”¨
        const mapPaths = document.querySelectorAll('.jp-map-pref');
        mapPaths.forEach(path => {
          const pref = path.getAttribute('data-pref');
          const stats = prefectureCounts[pref] || { total: 0, solo: 0, festival: 0 };
          const count = stats.total;
          
          // æ—¢å­˜ã®ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
          path.classList.remove('visited');
          
          // ãƒ©ã‚¤ãƒ–è¨˜éŒ²ãŒã‚ã‚‹éƒ½é“åºœçœŒã‚’ã‚´ãƒ¼ãƒ«ãƒ‰ã«å…‰ã‚‰ã›ã‚‹
          if (count > 0) {
            path.classList.add('visited');
          }

          if (pref) {
            path.setAttribute('data-total', String(stats.total));
            path.setAttribute('data-solo', String(stats.solo));
            path.setAttribute('data-festival', String(stats.festival));
            path.setAttribute('title', `${pref}: ${stats.total}å› (å˜ç‹¬:${stats.solo} / ãƒ•ã‚§ã‚¹:${stats.festival})`);
          }
        });

        updateArtistRanking();
      }

      async function initJapanMapSvg() {
        const container = document.getElementById('jpMapContainer');
        if (!container) {
          console.warn('Map container not found: jpMapContainer');
          return;
        }
        if (container.dataset.loaded === '1') return;

        try {
          const res = await fetch('https://cdn.jsdelivr.net/gh/geolonia/japanese-prefectures@master/map-full.svg', { cache: 'force-cache' });
          if (!res.ok) {
            throw new Error(`Failed to fetch map svg: ${res.status}`);
          }
          const svgText = await res.text();
          container.innerHTML = svgText;

          const svg = container.querySelector('svg');
          if (svg) {
            svg.classList.add('map-svg');
            svg.removeAttribute('width');
            svg.removeAttribute('height');
            svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
          }

          const prefGroups = container.querySelectorAll('.prefecture');
          prefGroups.forEach((g) => {
            const codeRaw = g.getAttribute('data-code');
            const code = codeRaw ? Number(codeRaw) : NaN;
            const prefName = Number.isFinite(code) ? PREF_BY_CODE[code] : '';
            if (!prefName) return;

            const shapes = g.querySelectorAll('path, polygon');
            shapes.forEach((shape) => {
              shape.classList.add('jp-map-pref');
              shape.setAttribute('data-pref', prefName);
              // inline fill/strokeãŒã‚ã‚‹ã¨CSSãŒåŠ¹ãã«ãã„ã®ã§æ¶ˆã™
              shape.removeAttribute('fill');
              shape.removeAttribute('stroke');
              shape.removeAttribute('stroke-width');
            });
          });

          if (svg) {
            // viewBoxã¯å…ƒSVGã®å®šç¾©ã‚’å°Šé‡ã—ã¦å›ºå®šï¼ˆBBoxè£œæ­£ã¯ç’°å¢ƒã«ã‚ˆã£ã¦ã‚ºãƒ¬ã‚‹ãŸã‚ã€ç¢ºå®Ÿæ€§å„ªå…ˆï¼‰
            // Geoloniaã®map-full.svgã¯å†…éƒ¨ã§translate/scaleã•ã‚Œã¦ãŠã‚Šã€0..1000ã®viewBoxã ã¨ç’°å¢ƒã«ã‚ˆã£ã¦è¦‹åˆ‡ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚ã€
            // ä½™ç™½è¾¼ã¿ã®viewBoxã§ç¢ºå®Ÿã«å…¨ä½“ãŒåã¾ã‚‹ã‚ˆã†ã«ã™ã‚‹
            svg.setAttribute('viewBox', '-90 -90 1180 1180');
          }

          container.dataset.loaded = '1';
          setupMapTooltip();
          updateMap();
        } catch (e) {
          console.error('Failed to init Japan SVG map', e);
          container.innerHTML = '<div style="padding:16px;color:#c9c9d6;font-size:14px;line-height:1.6;">åœ°å›³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br/>Chromeã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥é–‹ã„ã¦ã„ã‚‹å ´åˆã€å¤–éƒ¨SVGã®èª­ã¿è¾¼ã¿ãŒåˆ¶é™ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚<br/>ï¼ˆç°¡æ˜“å¯¾å‡¦ï¼‰VS Code / Windsurf ã® Live Server ç­‰ã§ http:// ã§é–‹ã„ã¦ãã ã•ã„ã€‚</div>';
        }
      }

      function buildPrefectureStats() {
        const stats = {};
        allEntries.forEach((entry) => {
          if (!entry) return;
          
          // å¹´ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
          if (selectedYear !== 'all') {
            const entryYear = new Date(entry.date).getFullYear().toString();
            if (entryYear !== selectedYear) return;
          }
          
          const pref = entry.prefecture;
          if (!pref) return;
          if (!stats[pref]) stats[pref] = { total: 0, solo: 0, festival: 0 };
          stats[pref].total += 1;
          if (entry.liveType === 'festival') {
            stats[pref].festival += 1;
          } else {
            stats[pref].solo += 1;
          }
        });
        return stats;
      }

      function setupMapTooltip() {
        const container = document.getElementById('jpMapContainer');
        const tooltip = document.getElementById('mapTooltip');
        if (!container || !tooltip) return;
        if (container.dataset.tooltipBound === '1') return;
        container.dataset.tooltipBound = '1';

        let activeTarget = null;

        const hide = () => {
          tooltip.classList.remove('visible');
          activeTarget = null;
        };

        const showFor = (target, clientX, clientY) => {
          const pref = target.getAttribute('data-pref') || '';
          const total = target.getAttribute('data-total') || '0';
          const solo = target.getAttribute('data-solo') || '0';
          const festival = target.getAttribute('data-festival') || '0';

          tooltip.innerHTML = `
            <div style="font-weight:800;color:var(--accent);margin-bottom:4px;">${pref}</div>
            <div style="color:var(--text-main);font-weight:700;">åˆè¨ˆ: ${total}å›</div>
            <div style="color:var(--text-muted);font-size:12px;">å˜ç‹¬: ${solo} / ãƒ•ã‚§ã‚¹: ${festival}</div>
          `;

          const rect = container.getBoundingClientRect();
          const offset = 12;
          const x = Math.min(rect.width - 220, Math.max(12, clientX - rect.left + offset));
          const y = Math.min(rect.height - 90, Math.max(12, clientY - rect.top + offset));
          tooltip.style.left = `${x}px`;
          tooltip.style.top = `${y}px`;
          tooltip.classList.add('visible');
        };

        container.addEventListener('mousemove', (e) => {
          const t = e.target && e.target.closest ? e.target.closest('.jp-map-pref') : null;
          if (!t || !container.contains(t)) {
            hide();
            return;
          }
          activeTarget = t;
          showFor(t, e.clientX, e.clientY);
        });

        container.addEventListener('mouseleave', () => {
          hide();
        });

        container.addEventListener('scroll', () => {
          if (activeTarget) hide();
        }, true);
      }

      // ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°
      function updateArtistRanking() {
        const rankingList = document.getElementById('artistRankingList');
        const expandBtn = document.getElementById('rankingExpand');
        if (!rankingList) return;
        
        // ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã”ã¨ã«é›†è¨ˆ
        const artistStats = {};
        allEntries.forEach(entry => {
          if (!entry) return;
          
          // å¹´ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
          if (selectedYear !== 'all') {
            const entryYear = new Date(entry.date).getFullYear().toString();
            if (entryYear !== selectedYear) return;
          }
          
          // çµ±ä¸€ã•ã‚ŒãŸã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šå‡¦ç†
          let names = [];
          if (entry.liveType === 'festival') {
            // ãƒ•ã‚§ã‚¹ï¼šartistsé…åˆ—ã‹ã‚‰å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã®ã¿ã‚’å¯¾è±¡ï¼ˆãƒ•ã‚§ã‚¹åã‚’é™¤å¤–ï¼‰
            if (Array.isArray(entry.artists) && entry.artists.length > 1) {
              names = entry.artists.slice(1); // ãƒ•ã‚§ã‚¹åã‚’é™¤å¤–
            }
          } else {
            // å˜ç‹¬ãƒ©ã‚¤ãƒ–ï¼šartistãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§åˆ†å‰²
            const artistStr = String(entry.artist || '').trim();
            if (artistStr) {
              names = artistStr.split(/[,ã€]/).map(s => String(s || '').trim()).filter(Boolean);
            }
          }

          // å„ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’é›†è¨ˆ
          names.forEach((name) => {
            if (!artistStats[name]) {
              artistStats[name] = { solo: 0, festival: 0, total: 0 };
            }
            artistStats[name][entry.liveType]++;
            artistStats[name].total++;
          });
        });

        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä½œæˆ
        let sortedArtists = Object.entries(artistStats)
          .sort((a, b) => b[1].total - a[1].total);

        // ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        if (rankingMode === 'solo') {
          sortedArtists = sortedArtists.filter(([_, stats]) => stats.solo > 0);
          sortedArtists.sort((a, b) => b[1].solo - a[1].solo);
        } else if (rankingMode === 'festival') {
          sortedArtists = sortedArtists.filter(([_, stats]) => stats.festival > 0);
          sortedArtists.sort((a, b) => b[1].festival - a[1].festival);
        }

        // è¡¨ç¤ºä»¶æ•°åˆ¶é™
        const displayLimit = rankingExpanded ? sortedArtists.length : Math.min(20, sortedArtists.length);
        const displayArtists = sortedArtists.slice(0, displayLimit);

        rankingList.innerHTML = displayArtists.map((artist, index) => {
          const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
          const countKey = rankingMode === 'solo' ? 'solo' : rankingMode === 'festival' ? 'festival' : 'total';
          return `
            <div class="ranking-item">
              <div class="ranking-number ${rankClass}">${index + 1}</div>
              <div class="ranking-artist">${artist[0]}</div>
              <div class="ranking-count">
                ${artist[1][countKey]}å›
                <span class="ranking-detail">(å˜ç‹¬: ${artist[1].solo} / ãƒ•ã‚§ã‚¹: ${artist[1].festival})</span>
              </div>
            </div>
          `;
        }).join('');

        // å±•é–‹ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
        if (expandBtn) {
          if (sortedArtists.length > 20) {
            expandBtn.style.display = 'block';
            expandBtn.textContent = rankingExpanded ? 'é–‰ã˜ã‚‹' : 'ã™ã¹ã¦è¦‹ã‚‹';
          } else {
            expandBtn.style.display = 'none';
          }
        }

        // ãƒªã‚¹ãƒˆã®é«˜ã•åˆ¶å¾¡
        if (rankingList) {
          rankingList.classList.toggle('expanded', rankingExpanded);
        }
      }

      // è¡¨ç¤ºæ›´æ–°
      function updateDisplay() {
        if (currentSection === 'collection') {
          renderTickets();
        } else if (currentSection === 'analytics') {
          updateMap();
          updateSummary();
        }
      }

      function updateAllDisplays() {
        renderTickets();
        updateMap();
        updateSummary();
      }

      function deleteEntryById(id) {
        if (!id) return;
        const before = allEntries.length;
        allEntries = allEntries.filter(en => en && en.id !== id);
        const after = allEntries.length;
        if (after === before) {
          console.warn('Entry not found for delete:', id);
        }
        saveEntries();
        updateAllDisplays();
      }

      // ãƒ•ã‚©ãƒ¼ãƒ è¨­å®š
      function setupForm() {
        const form = document.getElementById('liveFormNew');
        if (!form) {
          console.warn('Form not found: liveFormNew');
          return;
        }

        form.addEventListener('submit', handleFormSubmit);

        // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³
        const radioOptions = document.querySelectorAll('.radio-option-new');
        const festivalArtistsContainer = document.getElementById('festivalArtistsContainer');
        const artistInput = document.getElementById('artist');

        radioOptions.forEach(option => {
          option.addEventListener('click', () => {
            radioOptions.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            
            // ãƒ•ã‚§ã‚¹é¸æŠæ™‚ã®ã¿è¤‡æ•°ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆå…¥åŠ›ã‚’è¡¨ç¤º
            const selectedType = option.querySelector('input').value;
            if (!festivalArtistsContainer || !artistInput) return;

            if (selectedType === 'festival') {
              festivalArtistsContainer.style.display = 'block';
              artistInput.required = false;
              artistInput.placeholder = 'ä¾‹ï¼šãƒ•ã‚§ã‚¹å';
            } else {
              festivalArtistsContainer.style.display = 'none';
              artistInput.required = true;
              artistInput.placeholder = 'ä¾‹ï¼šBand Name';
            }
          });
        });

        // åˆæœŸé¸æŠçŠ¶æ…‹
        const checked = document.querySelector('.radio-option-new input:checked');
        if (checked && checked.parentElement) {
          checked.parentElement.classList.add('selected');
        }
      }

      // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
      function handleFormSubmit(e) {
        e.preventDefault();
        const form = e.target;

        if (!form || !form.title || !form.date || !form.venue || !form.prefecture || !form.liveType) {
          console.warn('Unexpected form structure', form);
          showToast('ãƒ•ã‚©ãƒ¼ãƒ ã®æ§‹é€ ãŒæƒ³å®šã¨é•ã„ã¾ã™');
          return;
        }
        
        const liveType = form.liveType.value;

        const festivalName = form.artist ? String(form.artist.value || '').trim() : '';
        const soloArtistStr = form.artist ? String(form.artist.value || '').trim() : '';
        const festivalArtistsRaw = form.festivalArtists ? String(form.festivalArtists.value || '') : '';
        const festivalArtistsList = (festivalArtistsRaw || '').split(/[,ã€]/).map(s => String(s || '').trim()).filter(Boolean);

        let artistsForSave = [];
        if (liveType === 'festival') {
          // ãƒ•ã‚§ã‚¹ï¼šãƒ•ã‚§ã‚¹å + å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ
          artistsForSave = Array.from(new Set([festivalName, ...festivalArtistsList].map(s => String(s || '').trim()).filter(Boolean)));
        } else {
          // å˜ç‹¬ãƒ©ã‚¤ãƒ–ï¼šã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šå¯¾å¿œï¼ˆå®Œå…¨ä¿®æ­£ï¼‰
          artistsForSave = soloArtistStr.split(/[,ã€]/).map(s => String(s || '').trim()).filter(Boolean);
        }

        if (!artistsForSave.length) {
          showToast('ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }

        if (editingEntryId) {
          const idx = allEntries.findIndex(en => en && en.id === editingEntryId);
          if (idx === -1) {
            console.warn('Editing entry not found:', editingEntryId);
            showToast('ç·¨é›†å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            editingEntryId = null;
            return;
          }

          const updated = {
            ...allEntries[idx],
            liveType: liveType,
            date: form.date.value,
            endDate: form.endDate && form.endDate.value ? form.endDate.value : '',
            venue: form.venue.value.trim(),
            seat: form.seat.value.trim(),
            prefecture: form.prefecture.value,
            setlist: form.setlist ? String(form.setlist.value || '').trim() : '',
            title: form.title.value.trim(),
            artist: form.artist ? String(form.artist.value || '').trim() : (allEntries[idx].artist || ''),
            artists: liveType === 'festival' ? artistsForSave : undefined,
            updatedAt: new Date().toISOString()
          };

          allEntries[idx] = updated;
          saveEntries();
          updateAllDisplays();
          showToast('æ›´æ–°ã—ã¾ã—ãŸ');
          editingEntryId = null;
          form.reset();
          setTimeout(() => switchSection('collection'), 200);
          return;
        }

        // å„ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã”ã¨ã«ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚’ä½œæˆ
        const baseEntry = {
          liveType: liveType,
          date: form.date.value,
          endDate: form.endDate && form.endDate.value ? form.endDate.value : '',
          venue: form.venue.value.trim(),
          seat: form.seat.value.trim(),
          prefecture: form.prefecture.value,
          setlist: form.setlist ? String(form.setlist.value || '').trim() : '',
          createdAt: new Date().toISOString()
        };

        const newEntry = {
          ...baseEntry,
          id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
          title: form.title.value.trim(),
          artist: form.artist ? String(form.artist.value || '').trim() : '',
          artists: liveType === 'festival' ? artistsForSave : undefined
        };

        allEntries.push(newEntry);
        saveEntries();
        updateDisplay();
        form.reset();
        
        // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        const firstRadio = document.querySelector('.radio-option-new');
        if (firstRadio) {
          firstRadio.classList.add('selected');
        }
        const festContainer = document.getElementById('festivalArtistsContainer');
        if (festContainer) {
          festContainer.style.display = 'none';
        }
        const artistInput = document.getElementById('artist');
        if (artistInput) {
          artistInput.required = true;
          artistInput.placeholder = 'ä¾‹ï¼šBand Name';
        }
        
        showToast(`ãƒ©ã‚¤ãƒ–ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼${artistsForSave.length > 1 ? `(${artistsForSave.length}ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ)` : ''}`);
        
        // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«åˆ‡ã‚Šæ›¿ãˆ
        setTimeout(() => switchSection('collection'), 500);
      }

      // ãƒã‚±ãƒƒãƒˆä¸€è¦§è¡¨ç¤º
      function renderTickets() {
        const grid = document.getElementById('ticketsGrid');
        const empty = document.getElementById('ticketsEmpty');

        if (!grid || !empty) {
          console.warn('Collection elements not found', { grid: !!grid, empty: !!empty });
          return;
        }
        
        if (allEntries.length === 0) {
          grid.style.display = 'none';
          empty.style.display = 'block';
          return;
        }
        
        grid.style.display = 'grid';
        empty.style.display = 'none';
        
        // æ—¥ä»˜ã®æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
        const sortedEntries = [...allEntries].sort((a, b) => 
          new Date(b.date) - new Date(a.date)
        );
        
        const maxArtistsInCard = 6;
        grid.innerHTML = sortedEntries.map(entry => {
          const typeLabel = entry.liveType === 'festival' ? 'ğŸª ãƒ•ã‚§ã‚¹' : 'ğŸ¤ å˜ç‹¬';
          const typeClass = entry.liveType === 'festival' ? 'festival' : 'solo';
          const hasSetlist = !!(entry.setlist && String(entry.setlist).trim());

          const start = formatDate(entry.date);
          const end = entry.endDate ? formatDate(entry.endDate) : '';
          const dateLabel = end ? `${start}ã€œ${end}` : start;

          let artistList = [];
          let mainArtist = '';
          
          if (entry.liveType === 'festival') {
            // ãƒ•ã‚§ã‚¹ï¼šå‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆï¼ˆãƒ•ã‚§ã‚¹åã‚’é™¤å¤–ï¼‰
            artistList = Array.isArray(entry.artists) && entry.artists.length > 1 
              ? entry.artists.slice(1) 
              : [];
            mainArtist = entry.artist || '';
          } else {
            // å˜ç‹¬ãƒ©ã‚¤ãƒ–ï¼šçµ±ä¸€ã•ã‚ŒãŸã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šå‡¦ç†
            const artistStr = String(entry.artist || '').trim();
            if (artistStr) {
              const allArtists = artistStr.split(/[,ã€]/).map(s => String(s || '').trim()).filter(Boolean);
              if (allArtists.length > 0) {
                mainArtist = allArtists[0]; // æœ€åˆã®ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’ãƒ¡ã‚¤ãƒ³ã«
                artistList = allArtists.slice(1); // æ®‹ã‚Šã‚’ã‚µãƒ–è¡¨ç¤ºç”¨
              }
            }
          }

          const shown = artistList.slice(0, maxArtistsInCard);
          const rest = Math.max(0, artistList.length - shown.length);
          const artistSummary = shown.length
            ? `${shown.join(' / ')}${rest ? ` / ä»–${rest}å` : ''}`
            : '';
          
          return `
            <div class="ticket-card ${typeClass}" data-entry-id="${entry.id}">
              <div class="ticket-header">
                <div class="ticket-title">${entry.title}</div>
                <div class="ticket-type">${typeLabel}</div>
              </div>
              <div class="ticket-body">
                <div class="ticket-artist">${mainArtist}</div>
                ${artistSummary ? `<div class="ticket-artists">${escapeHtml(artistSummary)}</div>` : ''}
                <div class="ticket-venue">${entry.venue}</div>
                <div class="ticket-sub">
                  <span class="ticket-date">${escapeHtml(dateLabel)}</span>
                  <span class="ticket-seat">${entry.seat}</span>
                </div>
                ${hasSetlist ? `
                  <button type="button" class="setlist-toggle" data-entry-id="${entry.id}">ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚’è¡¨ç¤º</button>
                  <div class="setlist-content" data-entry-id="${entry.id}">${escapeHtml(String(entry.setlist))}</div>
                ` : ''}
              </div>
            </div>
          `;
        }).join('');
      }

      function setupCollectionInteractions() {
        const grid = document.getElementById('ticketsGrid');
        if (!grid) return;
        if (grid.dataset.bound === '1') return;
        grid.dataset.bound = '1';

        const modal = document.getElementById('liveDetailModal');
        const modalTitle = document.getElementById('liveDetailTitle');
        const modalBody = document.getElementById('liveDetailBody');
        const modalClose = document.getElementById('liveDetailClose');

        const closeModal = () => {
          if (!modal) return;
          modal.classList.remove('open');
          modal.setAttribute('aria-hidden', 'true');
          if (modalBody) modalBody.innerHTML = '';
          if (modalTitle) modalTitle.textContent = '';
        };

        const openModalForId = (id) => {
          if (!modal || !modalTitle || !modalBody) return;
          const entry = allEntries.find(e => e && e.id === id);
          if (!entry) return;

          modalTitle.textContent = entry.title || 'ãƒ©ã‚¤ãƒ–è©³ç´°';

          const typeLabel = entry.liveType === 'festival' ? 'ãƒ•ã‚§ã‚¹' : 'å˜ç‹¬ãƒ©ã‚¤ãƒ–';
          const seatText = entry.seat ? String(entry.seat) : '';
          const setlistText = entry.setlist ? String(entry.setlist).trim() : '';

          const start = formatDate(entry.date);
          const end = entry.endDate ? formatDate(entry.endDate) : '';
          const dateLabel = end ? `${start}ã€œ${end}` : start;

          const festivalArtists = entry.liveType === 'festival' && Array.isArray(entry.artists)
            ? entry.artists.slice(1)
            : [];
          const festivalArtistsHtml = festivalArtists.length
            ? `
              <div class="modal-artists">
                <div class="modal-artists-title">å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</div>
                <div class="modal-artists-grid">${festivalArtists.map(a => `<div class="artist-chip">${escapeHtml(String(a))}</div>`).join('')}</div>
              </div>
            `
            : '';

          modalBody.innerHTML = `
            <div class="modal-kv">
              <div class="modal-k">ç¨®åˆ¥</div>
              <div class="modal-v">${escapeHtml(typeLabel)}</div>

              <div class="modal-k">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</div>
              <div class="modal-v">${escapeHtml(String(entry.artist || ''))}</div>

              <div class="modal-k">ä¼šå ´</div>
              <div class="modal-v">${escapeHtml(String(entry.venue || ''))}</div>

              <div class="modal-k">å…¬æ¼”æ—¥</div>
              <div class="modal-v">${escapeHtml(dateLabel)}</div>

              <div class="modal-k">éƒ½é“åºœçœŒ</div>
              <div class="modal-v">${escapeHtml(String(entry.prefecture || ''))}</div>

              ${seatText ? `
                <div class="modal-k">åº§å¸­</div>
                <div class="modal-v">${escapeHtml(seatText)}</div>
              ` : ''}
            </div>

            ${setlistText ? `
              <div class="modal-setlist">
                <div class="modal-setlist-title">ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆ</div>
                <div class="modal-setlist-box">${escapeHtml(setlistText)}</div>
              </div>
            ` : ''}

            ${festivalArtistsHtml}

            <div class="modal-actions">
              <button type="button" class="modal-primary" data-edit-id="${String(entry.id)}">ç·¨é›†</button>
              <button type="button" class="modal-danger" data-delete-id="${String(entry.id)}">ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã™ã‚‹</button>
            </div>
          `;

          modal.classList.add('open');
          modal.setAttribute('aria-hidden', 'false');
        };

        if (modalClose) {
          modalClose.addEventListener('click', () => closeModal());
        }

        if (modal) {
          modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
          });
        }

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') closeModal();
        });

        if (modalBody) {
          modalBody.addEventListener('click', (e) => {
            const deleteBtn = e.target && e.target.closest ? e.target.closest('[data-delete-id]') : null;
            if (deleteBtn) {
              const id = deleteBtn.getAttribute('data-delete-id');
              if (!id) return;
              const ok = confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');
              if (!ok) return;
              deleteEntryById(id);
              closeModal();
              showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
              return;
            }

            const editBtn = e.target && e.target.closest ? e.target.closest('[data-edit-id]') : null;
            if (editBtn) {
              const id = editBtn.getAttribute('data-edit-id');
              if (!id) return;
              const entry = allEntries.find(en => en && en.id === id);
              if (!entry) return;

              const form = document.getElementById('liveFormNew');
              if (!form) return;
              editingEntryId = id;

              const radio = form.querySelector(`input[name="liveType"][value="${entry.liveType}"]`);
              if (radio) {
                radio.checked = true;
                document.querySelectorAll('.radio-option-new').forEach(opt => opt.classList.remove('selected'));
                if (radio.parentElement) {
                  const wrapper = radio.closest('.radio-option-new');
                  if (wrapper) wrapper.classList.add('selected');
                }
              }

              const festContainer = document.getElementById('festivalArtistsContainer');
              const artistInput = document.getElementById('artist');
              if (festContainer && artistInput) {
                if (entry.liveType === 'festival') {
                  festContainer.style.display = 'block';
                  artistInput.required = false;
                  artistInput.placeholder = 'ä¾‹ï¼šãƒ•ã‚§ã‚¹å';
                } else {
                  festContainer.style.display = 'none';
                  artistInput.required = true;
                  artistInput.placeholder = 'ä¾‹ï¼šBand Name';
                }
              }

              if (form.title) form.title.value = entry.title || '';
              if (form.artist) form.artist.value = entry.artist || '';
              if (form.date) form.date.value = normalizeDateString(entry.date || '');
              if (form.endDate) form.endDate.value = entry.endDate ? normalizeDateString(entry.endDate) : '';
              if (form.venue) form.venue.value = entry.venue || '';
              if (form.seat) form.seat.value = entry.seat || '';
              if (form.prefecture) form.prefecture.value = entry.prefecture || '';
              if (form.setlist) form.setlist.value = entry.setlist || '';
              if (form.festivalArtists) {
                if (entry.liveType === 'festival' && Array.isArray(entry.artists)) {
                  form.festivalArtists.value = entry.artists.slice(1).join(', ');
                } else {
                  form.festivalArtists.value = '';
                }
              }

              closeModal();
              switchSection('add-live');
              setTimeout(() => {
                form.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }, 50);
              return;
            }
          });
        }

        grid.addEventListener('click', (e) => {
          const btn = e.target && e.target.closest ? e.target.closest('.setlist-toggle') : null;
          if (!btn) return;
          const id = btn.getAttribute('data-entry-id');
          if (!id) return;
          const content = grid.querySelector(`.setlist-content[data-entry-id="${id}"]`);
          if (!content) return;

          const isOpen = content.classList.toggle('open');
          btn.textContent = isOpen ? 'ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚’éš ã™' : 'ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚’è¡¨ç¤º';
        });

        grid.addEventListener('click', (e) => {
          const setlistBtn = e.target && e.target.closest ? e.target.closest('.setlist-toggle') : null;
          if (setlistBtn) return;
          const card = e.target && e.target.closest ? e.target.closest('.ticket-card') : null;
          if (!card || !grid.contains(card)) return;
          const id = card.getAttribute('data-entry-id');
          if (!id) return;
          openModalForId(id);
        });
      }

      function escapeHtml(s) {
        return s
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#39;');
      }

      // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
      function formatDate(dateStr) {
        if (!dateStr) return '';

        const normalized = normalizeDateString(dateStr);
        const date = new Date(normalized);

        if (Number.isNaN(date.getTime())) {
          console.warn('Invalid date string:', dateStr);
          return String(dateStr);
        }

        const y = String(date.getFullYear());
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      }

      function normalizeDateString(dateStr) {
        const s = String(dateStr).trim();
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
        if (/^\d{8}$/.test(s)) {
          return `${s.slice(0, 4)}-${s.slice(4, 6)}-${s.slice(6, 8)}`;
        }

        // e.g. "202204-04-24" -> "2022-04-24" (æœˆãŒé‡è¤‡ã—ã¦ã„ã‚‹å£Šã‚Œæ–¹)
        {
          const m = s.match(/^(\d{4})(\d{2})-(\d{2})-(\d{2})$/);
          if (m) {
            return `${m[1]}-${m[2]}-${m[4]}`;
          }
        }

        return s;
      }

      // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
      function showToast(message) {
        const toast = document.getElementById('toast');
        if (!toast) return;
        toast.textContent = message;
        toast.classList.add('visible');
        
        setTimeout(() => {
          toast.classList.remove('visible');
        }, 3000);
      }

      // ã‚¢ãƒ—ãƒªé–‹å§‹
      try {
        init();
      } catch (e) {
        console.error('Init failed', e);
        showToast('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆConsoleã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰');
      }
    })();
  </script>
</body>
</html>
